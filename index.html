<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>GitHub PR Tracker Input Generator</title>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 40px;
    }
    label {
      font-weight: bold;
    }
    select, input {
      margin: 10px 0;
      width: 300px;
      padding: 6px;
    }
    button {
      margin-top: 20px;
      padding: 10px 20px;
    }
    .output {
      margin-top: 30px;
      white-space: pre-wrap;
      background: #f7f7f7;
      padding: 15px;
      border-radius: 5px;
    }
  </style>
</head>
<body>

  <h2>GitHub PR Tracker Input Generator</h2>

  <label for="repoSelect">Select Repositories:</label><br />
  <select id="repoSelect" multiple size="8"></select><br />

  <input type="date" id="startDate" />
  <input type="date" id="endDate" /><br />

  <button onclick="generateYAML()">Generate YAML</button>

  <div class="output" id="yamlOutput"></div>
  <a id="downloadLink" style="display:none" download="workflow_input.yaml">Download YAML</a>

  <script>
    const repoSelect = document.getElementById("repoSelect");
    const manifestURL = "config/gss_hvs_git_repos.yaml";

    // Add "All" option
    const addAllOption = () => {
      const option = document.createElement("option");
      option.value = "__all__";
      option.text = "[Select All]";
      repoSelect.appendChild(option);
    };

    const loadManifest = async () => {
      const res = await fetch(manifestURL);
      const text = await res.text();
      const manifest = jsyaml.load(text);
      const repos = Object.keys(manifest.repos || {});
      addAllOption();
      repos.forEach(repo => {
        const option = document.createElement("option");
        option.value = repo;
        option.text = repo;
        repoSelect.appendChild(option);
      });
    };

    repoSelect.addEventListener("change", () => {
      const selected = Array.from(repoSelect.selectedOptions).map(o => o.value);
      console.log(selected)
      if (selected.includes("__all__")) {
        for (let i = 0; i < repoSelect.options.length; i++) {
          if (repoSelect.options[i].value !== "__all__") {
            repoSelect.options[i].selected = true;
          }
        }
        repoSelect.options[0].selected = false; // unselect the "__all__"
      }
    });

    function generateYAML() {
      const selectedRepos = Array.from(repoSelect.selectedOptions).map(o => o.value);
      console.log(selectedRepos);
      const startDate = document.getElementById("startDate").value;
      const endDate = document.getElementById("endDate").value;

      if (selectedRepos.length === 0) {
        alert("Please select at least one repo.");
        return;
      }

      if (startDate === null || endDate === null) {
        alert("Please select the dates.");
        return;
      }

      if (startDate > endDate) {
        alert("Start date must be earlier than end date.");
        return;
      }

      const yamlObj = {
        repos: selectedRepos.join(","),
        start_date: startDate,
        end_date: endDate
      };

      const yamlStr = jsyaml.dump(yamlObj);
      document.getElementById("yamlOutput").textContent = yamlStr;

      // download link
      const blob = new Blob([yamlStr], { type: "text/yaml" });
      const url = URL.createObjectURL(blob);
      const link = document.getElementById("downloadLink");
      link.href = url;
      link.style.display = "inline-block";
    }

    loadManifest();
  </script>

</body>
</html>
